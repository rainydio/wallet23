#!/bin/env -S fift -s

"lib.fif" include
"contract.fif" include <s constant code_slice

<b 1 8 u, b> constant req1
<b 2 8 u, b> constant req2

newkeypair nip 256 B>u@ constant key1
newkeypair nip 256 B>u@ constant key2
newkeypair nip 256 B>u@ constant key3

"seqno" $>id code_slice <b
	100 32 u,
	null nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	null nullref,
b> runvm drop 0 <> abort"error"
100 <> abort"seqno failure"

"keys" $>id code_slice <b
	100 32 u,
	null nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	null nullref,
b> runvm drop 0 <> abort"error"
2 pick 2 pick > abort"keys failure"
1 pick 1 pick > abort"keys failure"
drop drop drop

"last_request" $>id code_slice <b
	100 32 u,
	null nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	null nullref,
b> runvm drop 0 <> abort"error"
null? not abort"last_request failure"

"last_request" $>id code_slice <b
	100 32 u,
	req1 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	null nullref,
b> runvm drop 0 <> abort"error"
hashu req1 hashu <> abort"last_request failure"

"last_request_key" $>id code_slice <b
	100 32 u,
	null nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	null nullref,
b> runvm drop 0 <> abort"error"
null? not abort"last_request_key failure"

"last_request_key" $>id code_slice <b
	100 32 u,
	req1 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	null nullref,
b> runvm drop 0 <> abort"error"
key1 <> abort"last_request_key failure"

"prev_request" $>id code_slice <b
	100 32 u,
	null nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	null nullref,
b> runvm drop 0 <> abort"error"
null? not abort"prev_request failure"

"prev_request" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
hashu req1 hashu <> abort"prev_request failure"

"prev_request_key" $>id code_slice <b
	100 32 u,
	null nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	null nullref,
b> runvm drop 0 <> abort"error"
null? not abort"prev_request_key failure"

"prev_request_key" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
key3 <> abort"prev_request_key failure"

key1 "my_request" $>id code_slice <b
	100 32 u,
	null nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	null nullref,
b> runvm drop 0 <> abort"error"
null? not abort"my_request failure"

key3 "my_request" $>id code_slice <b
	100 32 u,
	null nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	null nullref,
b> runvm drop 0 <> abort"error"
null? not abort"my_request failure"

key1 "my_request" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
hashu req2 hashu <> abort"prev_request failure"

key2 "my_request" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
null? not abort"my_request failure"

key3 "my_request" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
hashu req1 hashu <> abort"my_request failure"

key1 "other_request1" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
hashu req1 hashu <> abort"other_request1 failure"

key2 "other_request1" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
hashu req1 hashu <> abort"other_request1 failure"

key3 "other_request1" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
hashu req2 hashu <> abort"other_request1 failure"

key1 "other_request1_key" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
key3 <> abort"other_request1_key failure"

key2 "other_request1_key" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
key3 <> abort"other_request1_key failure"

key3 "other_request1_key" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
key1 <> abort"other_request1_key failure"

key1 "other_request2" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
null? not abort"other_request2 failure"

key2 "other_request2" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
hashu req2 hashu <> abort"other_request2 failure"

key3 "other_request2" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
null? not abort"other_request2 failure"

key1 "other_request2_key" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
null? not abort"other_request2_key failure"

key2 "other_request2_key" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
key1 <> abort"other_request2_key failure"

key3 "other_request2_key" $>id code_slice <b
	100 32 u,
	req2 nullref,
	key1 256 u,
	key2 256 u,
	key3 256 u,
	req1 nullref,
b> runvm drop 0 <> abort"error"
null? not abort"other_request2_key failure"

depth 0 <> abort"stack depth"
